name: Build and Push (Production)
on:
  push:
    branches: [ main ]
    paths:
      - 'Dockerfile'
      - '*.sh'
  workflow_dispatch:
  repository_dispatch:
    types: [update]  

env:
  DOCKERHUB_REPO: avanavan/matcha-docker-tf2
  GHCR_REPO: ghcr.io/${{ github.repository }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          registry: docker.io
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Log in to ghcr
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ env.DOCKERHUB_REPO }}
            ${{ env.GHCR_REPO }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy-to-gcloud:
    runs-on: ubuntu-latest
    needs: build-and-push
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.MATCHA_GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Deploy to Google Cloud
        run: |
          #!/bin/bash
          set -e

          cleanup() {
              echo "Cleaning up: Deleting update-runner instance..."
              gcloud compute instances delete update-runner \
                  --zone=asia-southeast1-a \
                  --project=fresh-ocean-422212-c6 \
                  --verbosity=info \
                  --quiet 2>/dev/null || true
          }

          # Run cleanup on exit
          trap cleanup EXIT

          echo "Creating GCE instance...."

          gcloud compute instances create update-runner \
              --project=fresh-ocean-422212-c6 \
              --zone=asia-southeast1-a \
              --machine-type=n2d-custom-2-4096 \
              --network-interface=network-tier=PREMIUM,stack-type=IPV4_ONLY,subnet=default \
              --provisioning-model=SPOT \
              --instance-termination-action=STOP \
              --tags=tf2 \
              --create-disk=auto-delete=yes,boot=yes,device-name=update-runner,image=projects/fresh-ocean-422212-c6/global/images/matcha-docker-tf2,mode=rw,size=15,type=pd-balanced \
              --verbosity=info \

          echo "GCE instance created."

          # Wait till its ready
          echo "Preparing to SSH..."

          MAX_RETRIES=5
          RETRY_COUNT=0

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              echo "Attempt $((RETRY_COUNT + 1))/$MAX_RETRIES..."
              
              if gcloud compute ssh tf2server@update-runner \
                  --zone=asia-southeast1-a \
                  --project=fresh-ocean-422212-c6 \
                  --verbosity=info \
                  --command="echo 'SSH Ready'" 2>/dev/null; then
                  echo "SSH connection established."
                  break
              fi
              
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                  echo "SSH not ready yet. Waiting 10 seconds before retry..."
                  sleep 10
              fi
          done

          if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
              echo "Error: SSH connection could not be established after $MAX_RETRIES attempts."
              exit 1
          fi

          # Send docker pull command via ssh
          echo "Pulling latest docker image on instance..."

          gcloud compute ssh tf2server@update-runner \
              --zone=asia-southeast1-a \
              --project=fresh-ocean-422212-c6 \
              --verbosity=info \
              --command="docker pull ghcr.io/matcha-bookable/matcha-docker-tf2:latest ; echo DONE:\$?"

          if [ $? -ne 0 ]; then
              echo "Error pulling docker image."
              exit 1
          fi

          echo "Docker image pulled."

          # Stop instance so we can create a sourceImage
          echo "Gracefully stopping instance..."

          gcloud compute instances stop update-runner \
              --zone=asia-southeast1-a \
              --project=fresh-ocean-422212-c6 \
              --verbosity=info

          echo "Instance stopped."

          # Generate timestamp for unique image name
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          IMAGE_NAME="matcha-docker-tf2-${TIMESTAMP}"

          # Create image from the boot disk
          echo "Creating new image from updated disk..."
          gcloud compute images create ${IMAGE_NAME} \
              --project=fresh-ocean-422212-c6 \
              --source-disk=update-runner \
              --source-disk-zone=asia-southeast1-a \
              --family=matcha-docker-tf2 \
              --verbosity=info

          echo "New ${IMAGE_NAME} image created."

          # Delete old images
          echo "Cleaning up old images in family..."
          OLD_IMAGES=$(gcloud compute images list \
              --project=fresh-ocean-422212-c6 \
              --filter="family=matcha-docker-tf2 AND name!=${IMAGE_NAME}" \
              --format="value(name)" \
              --verbosity=info)

          if [ -n "$OLD_IMAGES" ]; then
              echo "Deleting old images: $OLD_IMAGES"
              echo "$OLD_IMAGES" | xargs -I {} gcloud compute images delete {} \
                  --project=fresh-ocean-422212-c6 \
                  --verbosity=info \
                  --quiet
              echo "Old images deleted."
          else
              echo "No old images to delete."
          fi

          echo "Google Cloud PASSED"